{% extends "admin/base_admin.html" %}
{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-2xl font-bold text-slate-800">Security & Feedback Analytics</h1>
        <p class="text-sm text-slate-500 font-mono">NODE_ID: CDAC-PUNE-01</p>
    </div>
    <a href="/admin/export/feedback" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-xs font-bold shadow-lg transition flex items-center">
        <span class="mr-2">ðŸ“¥</span> DOWNLOAD SECURE AUDIT (CSV)
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white p-6 rounded shadow border-t-4 border-slate-900">
        <h3 class="text-sm font-bold uppercase mb-4 text-slate-500">Module Rating Distribution</h3>
        <canvas id="ratingChart"></canvas>
    </div>
    <div class="bg-white p-6 rounded shadow border-t-4 border-slate-900">
        <h3 class="text-sm font-bold uppercase mb-4 text-slate-500">Course Participation SIEM</h3>
        <canvas id="courseChart"></canvas>
    </div>
</div>

<script>
    // Visualization 1: Bar Chart for Ratings
    new Chart(document.getElementById('ratingChart'), {
        type: 'bar',
        data: {
            labels: {{ labels | safe }},
            datasets: [{
                label: 'Average Rating',
                data: {{ values | safe }},
                backgroundColor: '#1c2b36',
                borderColor: '#d32f2f',
                borderWidth: 2
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true, max: 5 } } }
    });

    // Visualization 2: Doughnut for Course split
    new Chart(document.getElementById('courseChart'), {
        type: 'doughnut',
        data: {
            labels: {{ course_labels | safe }},
            datasets: [{
                data: {{ course_counts | safe }},
                backgroundColor: ['#d32f2f', '#1c2b36', '#4a5568', '#718096']
            }]
        }
    });
</script>
<div class="mb-8">
    <h1 class="text-2xl font-bold text-slate-800">Security Operations Dashboard</h1>
    <p class="text-sm text-slate-500">Real-time C-DAC Module Assessment Metrics</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    {% for label, val in [('Identities', stats.users), ('Audit Logs', stats.feedback), ('Active Courses', stats.courses), ('Access Events', stats.logins)] %}
    <div class="forti-card p-4 flex justify-between items-center">
        <div>
            <div class="text-xs font-bold text-gray-500 uppercase">{{ label }}</div>
            <div class="text-2xl font-bold text-slate-800">{{ val }}</div>
        </div>
        <div class="text-3xl opacity-20">ðŸ“ˆ</div>
    </div>
    {% endfor %}
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <div class="forti-card p-6">
        <h3 class="font-bold mb-4 border-b pb-2">Feedback Distribution by C-DAC Stream</h3>
        <canvas id="feedbackChart" height="200"></canvas>
    </div>
    <div class="forti-card p-6">
        <h3 class="font-bold mb-4 border-b pb-2">Access Control (Role Ratio)</h3>
        <canvas id="roleChart" height="200"></canvas>
    </div>
</div>

<div class="forti-card overflow-hidden">
    <div class="p-4 bg-slate-50 border-b font-bold text-sm text-slate-700 flex items-center">
        <span class="mr-2">ðŸ•’</span> RECENT ASSESSMENT TELEMETRY
    </div>
    <table class="w-full text-left text-sm">
        <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
            <tr>
                <th class="p-4">Identity</th>
                <th class="p-4">Scope (Course)</th>
                <th class="p-4">Module</th>
                <th class="p-4">Metric Score</th>
                <th class="p-4">Timestamp</th>
            </tr>
        </thead>
        <tbody>
            {% for f in recent_feedback %}
            <tr class="border-b hover:bg-gray-50 transition">
                <td class="p-4 font-medium text-blue-700">{{ f[0] }}</td>
                <td class="p-4">{{ f[1] }}</td>
                <td class="p-4 font-mono text-xs">{{ f[2] }}</td>
                <td class="p-4">
                    <span class="px-2 py-1 rounded bg-blue-100 text-blue-800 font-bold">{{ f[3] }}/5</span>
                </td>
                <td class="p-4 text-gray-400">{{ f[4] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // Animations and Data Injection
    const ctx1 = document.getElementById('feedbackChart').getContext('2d');
    new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: {{ chart_labels | safe }},
            datasets: [{
                label: 'Log Entries',
                data: {{ chart_values | safe }},
                backgroundColor: '#1c2b36',
                borderColor: '#d32f2f',
                borderWidth: 1
            }]
        },
        options: { animation: { duration: 2000 } }
    });

    const ctx2 = document.getElementById('roleChart').getContext('2d');
    new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['Admins', 'Students'],
            datasets: [{
                data: {{ role_data | safe }},
                backgroundColor: ['#d32f2f', '#1c2b36']
            }]
        }
    });
</script>
{% endblock %}
